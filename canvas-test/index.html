<html>


<head>

<style type="text/css">
@font-face {
    font-family: 'MemeImpact';
    src: url('impact.ttf');
}
</style>

<script type="text/javascript"> 

var ctx;
var WIDTH = 590;
var HEIGHT = 775;
var WOFF = WIDTH/2;
var HOFF = 60;

window.onload = function(){
    var c = document.getElementById('test');
    ctx = c.getContext("2d");
    ctx.strokeStyle = "#000";
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
    ctx.font = "60px MemeImpact";
    ctx.width = c.width;
    ctx.height = c.height;

//    ctx.fillText("asdf dicks and dicks!", 10, 10);

//    var d = c.toDataURL("image/png");
//    console.log(d);


//    var x = document.createElement('img');
//    x.id = 'foo';
//    x.src = d;

    var b = document.getElementById('body');
   
//    b.appendChild(x);


    var top = document.getElementById('top');
    var bottom = document.getElementById('bottom');

    top.onkeyup = function() {
        updateMemeText(top.value, bottom.value, ctx);
    }

    bottom.onkeyup = function() {
        updateMemeText(top.value, bottom.value, ctx);
    }

}


updateMemeText = function(t,b,ctx) {
    ctx.clearRect(0,0,WIDTH,HEIGHT);

    t = formatText(t, ctx);
    if (t) {
        for (var i = 0; i < t.length; i++) {
            ctx.strokeText(t[i],WOFF,HOFF+60*i,500);
            ctx.fillText(t[i],WOFF,HOFF+60*i,500);
        }
    }

    b = formatText(b, ctx);
    if (b) {
        for (var i = 0; i < b.length; i++) {
            ctx.fillText(b[i],WOFF,HEIGHT-HOFF-60*i,500);
            ctx.strokeText(b[i],WOFF,HEIGHT-HOFF-60*i,500);
        }
    }

    console.log(ctx.measureText(t));
//    console.log(formatText(t,ctx));
}

//writeText = function(text,ctx,x,y){
//    ctx.fillText(text,x,y);
//}


// formatText : text, ctx -> {array of text}

formatText = function(text, ctx) {
    var margin;
    var text_width = ctx.measureText(text).width;

//    console.log(text_width);
//    console.log("ctx width is " + ctx.width);

    if (text_width >= ctx.width) {
        var ta = text.split(" ");

        var i = 0;
        var newrow_width = 0;

        while (text_width - newrow_width >= ctx.width) {
            if (ta[ta.length - i]) {
                newrow_width += ctx.measureText(ta[ta.length - i]).width;
            }
            i++;
        }

        console.log("moving " + i + " words into second row");

        // we need to move i words onto a second row

        return [ta.slice(0,ta.length-i).join(" "),
               ta.slice(ta.length-i).join(" ")];
    } else {
        return [text];
    }
}

 
</script>

</head>

<body id="body" style="background: white;">
    <div width="590" height="775">
        <img src="http://csclub.uwaterloo.ca/~qxi/misc/Ducreux1.jpg" style="position:absolute;"/>
        <canvas id="test" width="590" height="775" style="position:relative;"> </canvas>
    </div>
    <form>
        <input type="text" name="top" id="top"/><br />
        <input type="text" name="bottom" id="bottom"/><br />
    </form>

</body>

</html>
