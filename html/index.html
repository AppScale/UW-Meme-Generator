<Html>


<head>

<style type="text/css">
@font-face {
    font-family: 'MemeImpact';
    src: url('static/impact.ttf');
}
</style>

<script type="text/javascript"> 

var ctx;
var WIDTH = 590;
var HEIGHT = 775;
var WOFF = WIDTH/2;
var HOFF = 60;

var changeStaging;

window.onload = function(){
    var c = document.getElementById('test');
    ctx = c.getContext("2d");
    ctx.strokeStyle = "#000";
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
    ctx.font = "60px MemeImpact";
    ctx.textBaseline = "middle";
    ctx.width = c.width;
    ctx.height = c.height;

//    ctx.fillText("asdf dicks and dicks!", 10, 10);

//    var d = c.toDataURL("image/png");
//    console.log(d);


//    var x = document.createElement('img');
//    x.id = 'foo';
//    x.src = d;

    var b = document.getElementById('body');
   
//    b.appendChild(x);


    var top = document.getElementById('top');
    var bottom = document.getElementById('bottom');

    top.onkeyup = function() {
        updateMemeText(top.value, bottom.value, ctx);
    }

    bottom.onkeyup = function() {
        updateMemeText(top.value, bottom.value, ctx);
    }

    var stagingTemplate = document.getElementById('staging_template');
    changeStaging = function(me) {
        // dynamically change the template
        var start = me.src.indexOf("id=")+3,
        old = me.src.substr(start,16),
        newTarget = "/serve?t=t&id=" + old,
        width = me.getAttribute('w'),
        height = me.getAttribute('h');

        stagingTemplate.src = newTarget;
        stagingTemplate.style.width = width;
        stagingTemplate.style.height = height;
    }

}


updateMemeText = function(t,b,ctx) {
    ctx.clearRect(0,0,WIDTH,HEIGHT);

    t = formatText(t, ctx);
    if (t) {
        for (var i = 0; i < t.length; i++) {
            ctx.fillText(t[i],WOFF,HOFF+60*i,500);
            ctx.strokeText(t[i],WOFF,HOFF+60*i,500);
        }
    }

    b = formatText(b, ctx);
    if (b) {
        for (var i = 0; i < b.length; i++) {
            ctx.fillText(b[i],WOFF,HEIGHT-HOFF-60*(b.length-1-i),500);
            ctx.strokeText(b[i],WOFF,HEIGHT-HOFF-60*(b.length-1-i),500);
        }
    }

    console.log(ctx.measureText(t));
//    console.log(formatText(t,ctx));
}

//writeText = function(text,ctx,x,y){
//    ctx.fillText(text,x,y);
//}


// formatText : text, ctx -> {array of text}

formatText = function(text, ctx) {
    var margin;
    var text_width = ctx.measureText(text).width;

//    console.log(text_width);
//    console.log("ctx width is " + ctx.width);

    if (text_width >= ctx.width) {
        var ta = text.split(" ");

        var i = 0;
        var newrow_width = 0;

        while (text_width - newrow_width >= ctx.width) {
            if (ta[ta.length - i]) {
                newrow_width += ctx.measureText(ta[ta.length - i]).width;
            }
            i++;
        }

        console.log("moving " + i + " words into second row");

        // we need to move i words onto a second row

        return [ta.slice(0,ta.length-i).join(" "),
               ta.slice(ta.length-i).join(" ")];
    } else {
        return [text];
    }
}

formatText2 = function(text, ctx) {
    ctx.width += 20; // add a bit of a margin

    var text_width = ctx.measureText(text).width;
    var space_width = ctx.measureText(" ").width;

//    console.log(text_width);
//    console.log("ctx width is " + ctx.width);

    if (text_width >= ctx.width) {
        // begin splitting lines
        var ta = text.split(" ");

        var i = 0;
        var newrow_width = 0;

        while (text_width - newrow_width >= ctx.width) {
            if (ta[ta.length - i]) {
                newrow_width += ctx.measureText(ta[ta.length - i]).width;
            }
            i++;
        }

        console.log("moving " + i + " words into second row");

        // we need to move i words onto a second row

        return [ta.slice(0,ta.length-i).join(" "),
               ta.slice(ta.length-i).join(" ")];
    } else {
        return [text];
    }
}
 
</script>

</head>

<body id="body" style="background: white;" style="width: 1500px;">

    <div id="c" style="width: 1500px;"> 
     <div id="editor" style="margin: 0; padding: 0; height: 775px; width: 456px; float: left;">
      <div width="456" height="600">
          <img id="staging_template" width="456" height="600" />
          <canvas id="test" width="456" height="600" style="position:relative;"> </canvas>
      </div>
      <form>
          <input type="text" name="top" id="top"/><br />
          <input type="text" name="bottom" id="bottom"/><br />
      </form>
     </div> <!-- editor done --!>
     
     <div id="thumbs" style="margin:0; padding: 0; height: 775px;">
     {% for t in templates %}
     <img src="/serve?t=t&id={{ t.0 }}&s=t" onclick="changeStaging(this);" w="{{ t.2 }}" h="{{t.3}}"/>
     {% endfor %}
     </div>

    </div>

</body>

</html>
