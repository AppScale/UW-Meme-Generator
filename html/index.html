<Html>


<head>

<style type="text/css">
@font-face {
    font-family: 'MemeImpact';
    src: url('static/impact.ttf');
}
#bake {
    color: #000;
/*    margin-left: 250px; */
    margin-bottom: 20px;
    background-color: transparent;
    border-color: #EE82EE;
    border-width: 1px;
}
#bake:hover {
    color: #EE82EE;
    border-color: #EE82EE;
}
submit:hover {
    color: red;
}
</style>

<script type="text/javascript"> 

var ctx;
//var WIDTH = 590;
//var HEIGHT = 775;
//var WOFF = WIDTH/2;
var HOFF = 60;

var changeStaging, addMeme;


window.onload = function(){
    var c = document.getElementById('editor-canvas');
//    c.style.width = c.width;
//    c.style.height = c.height;

    ctx = c.getContext("2d");
//    ctx.strokeStyle = "#000";
//    ctx.lineWidth = 2;
//    ctx.fillStyle = "#fff";
//    ctx.textAlign = "center";
//    ctx.font = "60px MemeImpact";
//    ctx.textBaseline = "middle";
    ctx = initContextForText(ctx);

//    ctx.width = c.width;
//    ctx.height = c.height;

//    ctx.fillText("asdf dicks and dicks!", 10, 10);

//    var d = c.toDataURL("image/png");
//    console.log(d);


//    var x = document.createElement('img');
//    x.id = 'foo';
//    x.src = d;

    var b = document.getElementById('body');
   
//    b.appendChild(x);


    var top = document.getElementById('top');
    var bottom = document.getElementById('bottom');

    top.onkeyup = function() {
        updateMemeText(top.value, bottom.value, ctx);
    }

    bottom.onkeyup = function() {
        updateMemeText(top.value, bottom.value, ctx);
    }

    var stagingTemplate = document.getElementById('staging_template'),
    canvasElement = document.getElementById('editor-canvas'),
    editorElement = document.getElementById('editor');


        changeStaging = function(me) {
        // dynamically change the template
        var start = me.src.indexOf("id=")+3,
        old = me.src.substr(start,16),
        newTarget = "/serve?t=t&id=" + old,
        width = me.getAttribute('w'),
        height = me.getAttribute('h'),
        targets = [editorElement, stagingTemplate],
        tlen = targets.length;

        stagingTemplate.src = newTarget;
        for (var t = 0; t < tlen; t++){
            targets[t].style.width = width;
            targets[t].style.height = height;
        }
        canvasElement.width = width;
        
        var newCanvas = document.createElement('canvas'),
        editor = document.getElementById('editor');
        //newCanvas.style = c.style;
        newCanvas.width = width;
        newCanvas.height = height;
        newCanvas.style.position = 'relative';
        var c = document.getElementById('editor-canvas');
        editor.removeChild(c);
        newCanvas.id = 'editor-canvas';
        editor.childNodes[editor.childNodes.length] = document.getElementById('input');
        editor.appendChild(newCanvas);
        editor.appendChild(document.getElementById('input'));
        editor.childNodes[5] = undefined;
        console.log("editor-canvas should be not null and is " + document.getElementById('editor-canvas'));

        var c = document.getElementById('editor-canvas');
        //    c.style.width = c.width;
        //    c.style.height = c.height;
            var ctx = c.getContext("2d");
            ctx = initContextForText(ctx);

            console.log("new canvas height is actually " + ctx.canvas.height);


        top.onkeyup = function() {
            updateMemeText(top.value, bottom.value, ctx);
        }

        bottom.onkeyup = function() {
            updateMemeText(top.value, bottom.value, ctx);
        }

        updateMemeText(top.value, bottom.value, ctx);

   }


    addMeme = function(f){
        var theC = document.getElementById('editor-canvas'),
        template = document.getElementById('staging_template'),
        theCTxt = theC.getContext("2d");

        theCTxt.drawImage(template, 0, 0);
        updateMemeText(f.top.value, f.bottom.value, theCTxt,false);

        var theMeme = theC.toDataURL("image/png"),
        imgField = document.createElement('input');

        imgField.type = 'hidden';
        imgField.value = theMeme;
        imgField.name = 'meme';
        imgField.id = 'meme';

        f.appendChild(imgField);
        return true;
    };


}


// buttsecks the canvas context so we can write text properly
initContextForText = function (ctx) {

    ctx.setFontSize = function (size) {
        if (size !== this.fontsize) {
            this.fontsize = size;
            this.font = size + "px MemeImpact";

            console.log("changed font size to " + this.fontsize);
            console.log("changed font style string to " + this.font);
        }
    }

    ctx.recomputeFontSize = function () {
        // scale font size for meme canvas height
        var fontsize = Math.min(Math.ceil(0.12*this.canvas.height), 54);
        this.setFontSize(fontsize);

        console.log("recomputing text size based on canvas height of " + this.canvas.height);
    }

    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
//    ctx.font = "60px MemeImpact";
//    ctx.fontsize = 60; // remember our font size baby
    ctx.textBaseline = "middle";

    ctx.recomputeFontSize();

    return ctx;
}

updateMemeText = function(t,b,ctx,noclear) {
    if (noclear !== false) {
        // clear canvas and redraw
        ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    }

    console.log("height: " + ctx.canvas.height + " width: " + ctx.canvas.width);

    // make nice offsets for line spacing and vertical margin
    var v_off = ctx.fontsize;
//    var woff = ; 

    t = formatText(t, ctx);
    if (t) {
        for (var i = 0; i < t.length; i++) {
            ctx.fillText(t[i],ctx.canvas.width/2,v_off+v_off*i);
            ctx.strokeText(t[i],ctx.canvas.width/2,v_off+v_off*i);
        }
    }

    b = formatText(b, ctx);
    if (b) {
        for (var i = 0; i < b.length; i++) {
            ctx.fillText(b[i],ctx.canvas.width/2,ctx.canvas.height-v_off-v_off*(b.length-1-i));
            ctx.strokeText(b[i],ctx.canvas.width/2,ctx.canvas.height-v_off-v_off*(b.length-1-i));
        }
    }

    console.log(ctx.measureText(t));
    //console.log(formatText(t,ctx));
}

formatText = function(text, ctx) {
//    ctx.width -= 5; // add a bit of a margin

    var text_width = ctx.measureText(text).width;

    if (text_width >= ctx.canvas.width) {
        console.log("text length exceeded");
        // begin splitting lines

        // we want a 2D array of words
        var out = breakTextArray(text.split(" "), ctx);

        // merge rows back into strings
        for (var i = 0; i < out.length; i++) {
            out[i] = out[i].join(" ");
        }

        return out;
    } else {
        return [text];
    }
}

// break a 2D array of words into more rows until they fit
breakTextArray = function(ta, ctx) {
    if (wordArrayLength(ta, ctx) > ctx.canvas.width && ta.length > 1) {
        console.log("breaking a row of length " +  ta.length);
        // find min number of words required to make first line fit
        var i;
        for (i = 0; i < ta.length; i++) {
            if (wordArrayLength(ta.slice(0,i+1), ctx) > ctx.canvas.width) {
                var cutpt = Math.max(i,1);
                return [ta.slice(0,cutpt)].concat(breakTextArray(ta.slice(cutpt),ctx));
            }

        }

    }
    console.log("wtf man");
    return [ta];
}

// find length of 1-D word array given canvas context
wordArrayLength = function(a, ctx) {
    var spc_width = ctx.measureText(" ").width;
    var total_length = 0;

    for (var i = 0; i < a.length; i++) {
        total_length += ctx.measureText(a[i]).width;
    }

    total_length += spc_width*(Math.max(a.length-1,0));

    console.log("wordArrayLength finds length of " + total_length);
    return total_length;
}

</script>

</head>

<body id="body" style="background: white;" style="width: 950px;">

    <div id="header">
        <div id="header_contents" style="width: 950px; margin: 0 auto 0 auto;">
            <img src="static/waterlol_banner.png" />
        </div>
        <hr />
    </div>

    <div id="c" style="width: 950px; margin: 0 auto 0 auto;"> 
     <div id="editor" style="margin: 0 12px 0 0; padding: 0; height: 775px; width: 500px; float: left;">
          <img id="staging_template" width="456" height="600" style="position: absolute;" />
          <canvas id="editor-canvas" width="456" height="600" style="position:relative; z-index=1"> </canvas>
      <div id="controls" style="margin-top: 6px">
          <form id="input" enctype="multipart/form-data" method="post" onSubmit="return addMeme(this);" action="/addMeme">
              <input type="submit" name="bake" id="bake" value="bake" style="float:right;" tabindex=3 />
              <div class="textfield"><label for="top">Top: </label><input type="text" name="top" id="top" tabindex=1 /></div>
              <div class="textfield"><label for="bottom">Bottom: </label><input type="text" name="bottom" id="bottom" tabindex=2 /></div>
              <p>Don't see any templates you like? <a href="addTemplate">Upload your own!</a><p />
          </form>
     </div>
     </div> <!-- editor done --!>
     
     <div id="thumbs" style="margin: 5px; padding: 0; height: 775px;">
     {% for t in templates %}
        <img src="/serve?t=t&id={{ t.0 }}&s=t" onclick="changeStaging(this);" w="{{ t.2 }}" h="{{t.3}}"/ id="{{ t.0 }}">
     {% endfor %}
     </div>

    </div>

</body>

</html>
