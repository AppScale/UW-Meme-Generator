<Html>


<head>

<style type="text/css">
@font-face {
    font-family: 'MemeImpact';
    src: url('static/impact.ttf');
}
#bake {
    color: #000;
/*    margin-left: 250px; */
    margin-bottom: 20px;
    background-color: transparent;
    border-color: #EE82EE;
    border-width: 1px;
}
#bake:hover {
    color: #EE82EE;
    border-color: #EE82EE;
}
<!-- <input type="submit" name="bake" id="bake" value="bake" style="margin-left: 250px; color: #EE82EE; background-color: black; border-color: black;" />
--!>
submit:hover {
    color: red;
}
</style>

<script type="text/javascript"> 

var ctx;
//var WIDTH = 590;
//var HEIGHT = 775;
//var WOFF = WIDTH/2;
var HOFF = 60;

var changeStaging, addMeme;


window.onload = function(){
    var c = document.getElementById('editor-canvas');
//    c.style.width = c.width;
//    c.style.height = c.height;
    ctx = c.getContext("2d");
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
    ctx.font = "60px MemeImpact";
    ctx.textBaseline = "middle";
//    ctx.width = c.width;
//    ctx.height = c.height;

//    ctx.fillText("asdf dicks and dicks!", 10, 10);

//    var d = c.toDataURL("image/png");
//    console.log(d);


//    var x = document.createElement('img');
//    x.id = 'foo';
//    x.src = d;

    var b = document.getElementById('body');
   
//    b.appendChild(x);


    var top = document.getElementById('top');
    var bottom = document.getElementById('bottom');

    top.onkeyup = function() {
        updateMemeText(top.value, bottom.value, ctx);
    }

    bottom.onkeyup = function() {
        updateMemeText(top.value, bottom.value, ctx);
    }

    var stagingTemplate = document.getElementById('staging_template'),
    canvasElement = document.getElementById('editor-canvas'),
    editorElement = document.getElementById('editor');


        changeStaging = function(me) {
        // dynamically change the template
        var start = me.src.indexOf("id=")+3,
        old = me.src.substr(start,16),
        newTarget = "/serve?t=t&id=" + old,
        width = me.getAttribute('w'),
        height = me.getAttribute('h'),
        targets = [editorElement, stagingTemplate],
        tlen = targets.length;

        stagingTemplate.src = newTarget;
        for (var t = 0; t < tlen; t++){
            targets[t].style.width = width;
            targets[t].style.height = height;
        }
        canvasElement.width = width;
        
        var newCanvas = document.createElement('canvas'),
        editor = document.getElementById('editor');
        //newCanvas.style = c.style;
        newCanvas.width = width;
        newCanvas.height = height;
        newCanvas.style.position = 'relative';
        var c = document.getElementById('editor-canvas');
        editor.removeChild(c);
        newCanvas.id = 'editor-canvas';
        editor.childNodes[editor.childNodes.length] = document.getElementById('input');
        editor.appendChild(newCanvas);
        editor.appendChild(document.getElementById('input'));
        editor.childNodes[5] = undefined;
        console.log("editor-canvas should be not null and is " + document.getElementById('editor-canvas'));

        var c = document.getElementById('editor-canvas');
        //    c.style.width = c.width;
        //    c.style.height = c.height;
            var ctx = c.getContext("2d");
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.fillStyle = "#fff";
            ctx.textAlign = "center";
            ctx.font = "60px MemeImpact";
            ctx.textBaseline = "middle";

            console.log("new canvas height is actually " + ctx.canvas.height);


        top.onkeyup = function() {
            updateMemeText(top.value, bottom.value, ctx);
        }

        bottom.onkeyup = function() {
            updateMemeText(top.value, bottom.value, ctx);
        }

        updateMemeText(top.value, bottom.value, ctx);

   }


    addMeme = function(f){
        var theC = document.getElementById('editor-canvas'),
        template = document.getElementById('staging_template'),
        theCTxt = theC.getContext("2d");

        theCTxt.drawImage(template, 0, 0);
        updateMemeText(f.top.value, f.bottom.value, theCTxt,false);

        var theMeme = theC.toDataURL("image/jpeg"),
        imgField = document.createElement('input');

        imgField.type = 'hidden';
        imgField.value = theMeme;
        imgField.name = 'meme';
        imgField.id = 'meme';

        f.appendChild(imgField);
        return true;
    };


}


updateMemeText = function(t,b,ctx,bool) {
    if (bool !== false) {
        ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    }

    console.log("height: " + ctx.canvas.height + " width: " + ctx.canvas.width);


    t = formatText2(t, ctx);
    if (t) {
        for (var i = 0; i < t.length; i++) {
            ctx.fillText(t[i],ctx.canvas.width/2,HOFF+60*i);
            ctx.strokeText(t[i],ctx.canvas.width/2,HOFF+60*i);
        }
    }

    b = formatText2(b, ctx);
    if (b) {
        for (var i = 0; i < b.length; i++) {
            ctx.fillText(b[i],ctx.canvas.width/2,ctx.canvas.height-HOFF-60*(b.length-1-i));
            ctx.strokeText(b[i],ctx.canvas.width/2,ctx.canvas.height-HOFF-60*(b.length-1-i));
        }
    }

    console.log(ctx.measureText(t));
    //console.log(formatText(t,ctx));
}


//////formatText = function(text, ctx) {
//////    var margin;
//////    var text_width = ctx.measureText(text).width;
//////
////////    console.log(text_width);
////////    console.log("ctx width is " + ctx.width);
//////
//////    if (text_width >= ctx.width) {
//////        var ta = text.split(" ");
//////
//////        var i = 0;
//////        var newrow_width = 0;
//////
//////        while (text_width - newrow_width >= ctx.width) {
//////            if (ta[ta.length - i]) {
//////                newrow_width += ctx.measureText(ta[ta.length - i]).width;
//////            }
//////            i++;
//////        }
//////
//////        console.log("moving " + i + " words into second row");
//////
//////        // we need to move i words onto a second row
//////
//////        return [ta.slice(0,ta.length-i).join(" "),
//////               ta.slice(ta.length-i).join(" ")];
//////    } else {
//////        return [text];
//////    }
//////}

formatText2 = function(text, ctx) {
//    ctx.width -= 5; // add a bit of a margin

    var text_width = ctx.measureText(text).width;

    if (text_width >= ctx.canvas.width) {
        console.log("text length exceeded");
        // begin splitting lines

        // we want a 2D array of words
        var out = breakTextArray(text.split(" "), ctx);

        // merge rows back into strings
        for (var i = 0; i < out.length; i++) {
            out[i] = out[i].join(" ");
        }

        return out;
    } else {
        return [text];
    }
}

// break a 2D array of words into more rows until they fit
breakTextArray = function(ta, ctx) {
    if (wordArrayLength(ta, ctx) > ctx.canvas.width && ta.length > 1) {
        console.log("breaking a row of length " +  ta.length);
        // find min number of words required to make first line fit
        var i;
        for (i = 0; i < ta.length; i++) {
            if (wordArrayLength(ta.slice(0,i+1), ctx) > ctx.canvas.width) {
                var cutpt = Math.max(i,1);
                return [ta.slice(0,cutpt)].concat(breakTextArray(ta.slice(cutpt),ctx));
            }

        }

    }
    console.log("wtf man");
    return [ta];
}

// find length of 1-D word array given canvas context
wordArrayLength = function(a, ctx) {
    var spc_width = ctx.measureText(" ").width;
    var total_length = 0;

    for (var i = 0; i < a.length; i++) {
        total_length += ctx.measureText(a[i]).width;
    }

    total_length += spc_width*(Math.max(a.length-1,0));

    console.log("wordArrayLength finds length of " + total_length);
    return total_length;
}

</script>

</head>

<body id="body" style="background: white;" style="width: 950px;">

    <div id="header">
        <div id="header_contents" style="width: 950px; margin: 0 auto 0 auto;">
            <img src="static/waterlol_banner.png" />
        </div>
        <hr />
    </div>

    <div id="c" style="width: 950px; margin: 0 auto 0 auto;"> 
     <div id="editor" style="margin: 0 12px 0 0; padding: 0; height: 775px; width: 500px; float: left;">
          <img id="staging_template" width="456" height="600" style="position: absolute;" />
          <canvas id="editor-canvas" width="456" height="600" style="position:relative; z-index=1"> </canvas>
      <form id="input" enctype="multipart/form-data" method="post" onSubmit="return addMeme(this);" action="/addMeme">
          <label for="top">Top: </label><input type="text" name="top" id="top" tabindex=1 />
          <input type="submit" name="bake" id="bake" value="bake" style="float:right;" tabindex=3 />
          <br />
          <label for="bottom">Bottom: </label><input type="text" name="bottom" id="bottom" tabindex=2 />
          <br />

      </form>
     </div> <!-- editor done --!>
     
     <div id="thumbs" style="margin: 5px; padding: 0; height: 775px;">
     {% for t in templates %}
        <img src="/serve?t=t&id={{ t.0 }}&s=t" onclick="changeStaging(this);" w="{{ t.2 }}" h="{{t.3}}"/ id="{{ t.0 }}">
     {% endfor %}
     </div>

    </div>

</body>

</html>
