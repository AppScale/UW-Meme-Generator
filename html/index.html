<Html>


<head>
<link href="static/style.css" rel="stylesheet" type="text/css">


<style type="text/css">
@font-face {
    font-family: 'MemeImpact';
    src: url('static/impact.ttf');
}
#bake {
    color: #000;
/*    margin-left: 250px; */
/*    margin-bottom: 10px; */
    background-color: transparent;
    border-color: #EE82EE;
    border-width: 2px;
    height: 60px;
    width: 96px;
    font-family: helvetical, arial, sans-serif;
    font-weight: bold;
    font-size: 22px;
}
#bake:hover {
    color: #EE82EE;
    border-color: #EE82EE;
}
submit:hover {
    color: red;
}
input {
    font-family: helvetica, arial, sans-serif;
    border-style: solid;
    border-width: 1px;
    border-color: black;
    padding-left: 1px;
    font-size: 18px;
}
</style>

<script type="text/javascript"> 

var ctx;
//var WIDTH = 590;
//var HEIGHT = 775;
//var WOFF = WIDTH/2;
var HOFF = 60;

var changeStaging, addMeme;


window.onload = function(){
    var c = document.getElementById('editor-canvas');

    ctx = c.getContext("2d");
    ctx = initContextForText(ctx);

    var b = document.getElementById('body');
   
    var top = document.getElementById('top');
    var bottom = document.getElementById('bottom');

    var fields = [top, bottom];
    var defaults = ["Top text", "Bottom text"];

    for (var i = 0; i < fields.length; i++) {
        fields[i].modified = false;
        fields[i].value = defaults[i];
        fields[i].default = defaults[i];

        fields[i].onkeyup = function() {
            this.modified = true;

            updateMemeTextFromFields(top,bottom,ctx);
        }

        // clear the default value in text field
        fields[i].onfocus = function() {
            if (!this.modified) {
                this.value = "";
            }
        }

        // unclear the default value in text field
        fields[i].onblur = function() {
            if (this.value === "" && !this.modified) {
                this.value = this.default;
            }
        }

    }


    var stagingTemplate = document.getElementById('staging_template'),
    canvasElement = document.getElementById('editor-canvas'),
    editorElement = document.getElementById('editor'),
    loadingImg = document.createElement('img');

    loadingImg.id = 'loading';
    loadingImg.src = '/static/loading.gif';
    editor.appendChild(loadingImg);
    loadingImg.onload = function() {
        this.style.display= 'none';
        this.style.position = 'relative';
        this.style.float = 'left';
        this.style.zIndex = 0;
        this.style.marginLeft = '230px';
        this.style.marginTop = '250px';
    };


    changeStaging = function(me) {
        stagingTemplate.style.display = 'none';
        loadingImg.style.display = 'block';
        // dynamically change the template
        var start = me.src.indexOf("id=")+3,
        old = me.src.substr(start,16),
        newTarget = "/serve?t=t&id=" + old,
        width = me.getAttribute('w'),
        height = me.getAttribute('h'),
        targets = [stagingTemplate];//editorElement, stagingTemplate],
        tlen = targets.length;

        x = function() {
            stagingTemplate.style.display = 'block';
            loadingImg.style.display = 'none';
            for (var t = 0; t < tlen; t++) {
                targets[t].style.width = width;
                targets[t].style.height = height;
            }
            
            var newCanvas = document.createElement('canvas'),
            editor = document.getElementById('editor');
            newCanvas.width = width;
            newCanvas.height = height;
            newCanvas.style.position = 'relative';

            var c = document.getElementById('editor-canvas');
            editor.removeChild(c);
            newCanvas.id = 'editor-canvas';
            editor.childNodes[editor.childNodes.length] = document.getElementById('input');
            editor.appendChild(newCanvas);
            editor.appendChild(document.getElementById('input'));
            editor.childNodes[5] = undefined;

            var c = document.getElementById('editor-canvas');
            var ctx = c.getContext("2d");
            ctx = initContextForText(ctx);


            top.onkeyup = function() {
                this.modified = true;

                updateMemeTextFromFields(top,bottom,ctx);
            }

            bottom.onkeyup = function() {
                this.modified = true;

                updateMemeTextFromFields(top,bottom,ctx);
            }

            updateMemeTextFromFields(top,bottom,ctx);
        }
        stagingTemplate.onload = x;
        stagingTemplate.src = newTarget;
   }


    addMeme = function(f){
        var theC = document.getElementById('editor-canvas'),
        template = document.getElementById('staging_template'),
        theCTxt = theC.getContext("2d");

        theCTxt.drawImage(template, 0, 0);
        updateMemeTextFromFields(top, bottom, theCTxt, false);

        var theMeme = theC.toDataURL("image/jpeg"),
        imgField = document.createElement('input');

        imgField.type = 'hidden';
        imgField.value = theMeme;
        imgField.name = 'meme';
        imgField.id = 'meme';

        f.appendChild(imgField);
        return true;
    };


}


// buttsecks the canvas context so we can write text properly
initContextForText = function (ctx) {

    ctx.setFontSize = function (size) {
        if (size !== this.fontsize) {
            this.fontsize = size;
            this.font = size + "px MemeImpact";

            console.log("changed font size to " + this.fontsize);
            console.log("changed font style string to " + this.font);
        }
    }

    ctx.recomputeFontSize = function () {
        // scale font size for meme canvas height
        var fontsize = Math.min(Math.ceil(0.12*this.canvas.height), 54);
        this.setFontSize(fontsize);

        console.log("recomputing text size based on canvas height of " + this.canvas.height);
    }

    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.fillStyle = "#fff";
    ctx.textAlign = "center";
//    ctx.font = "60px MemeImpact";
//    ctx.fontsize = 60; // remember our font size baby
    ctx.textBaseline = "middle";

    ctx.recomputeFontSize();

    return ctx;
}

// takes field objects. Reads them and updates fields.
updateMemeTextFromFields = function (top, bottom, ctx, redraw) {
    if (!top.modified && !bottom.modified) {
        return;
    } else if (!top.modified) {
        writeMemeText("", bottom.value, ctx, redraw);
    } else if (!bottom.modified) {
        writeMemeText(top.value, "", ctx, redraw);
    } else {
        writeMemeText(top.value, bottom.value, ctx, redraw);
    }
}


writeMemeText = function(t,b,ctx,redraw) {
    if (redraw !== false) {
        // clear canvas and redraw
        ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    }

    console.log("height: " + ctx.canvas.height + " width: " + ctx.canvas.width);

    // make nice offsets for line spacing and vertical margin
    var v_off = ctx.fontsize;
//    var woff = ; 

    t = formatText(t, ctx);
    if (t) {
        for (var i = 0; i < t.length; i++) {
            ctx.fillText(t[i],ctx.canvas.width/2,v_off+v_off*i);
            ctx.strokeText(t[i],ctx.canvas.width/2,v_off+v_off*i);
        }
    }

    b = formatText(b, ctx);
    if (b) {
        for (var i = 0; i < b.length; i++) {
            ctx.fillText(b[i],ctx.canvas.width/2,ctx.canvas.height-v_off-v_off*(b.length-1-i));
            ctx.strokeText(b[i],ctx.canvas.width/2,ctx.canvas.height-v_off-v_off*(b.length-1-i));
        }
    }

    console.log(ctx.measureText(t));
    //console.log(formatText(t,ctx));
}


formatText = function(text, ctx) {
//    ctx.width -= 5; // add a bit of a margin
    if (!text) {
        return;
    }

    var text_width = ctx.measureText(text).width;

    if (text_width >= ctx.canvas.width) {
        console.log("text length exceeded");
        // begin splitting lines

        // we want a 2D array of words
        var out = breakTextArray(text.split(" "), ctx);

        // merge rows back into strings
        for (var i = 0; i < out.length; i++) {
            out[i] = out[i].join(" ");
        }

        return out;
    } else {
        return [text];
    }
}

// break a 2D array of words into more rows until they fit
breakTextArray = function(ta, ctx) {
    if (wordArrayLength(ta, ctx) > ctx.canvas.width && ta.length > 1) {
        console.log("breaking a row of length " +  ta.length);
        // find min number of words required to make first line fit
        var i;
        for (i = 0; i < ta.length; i++) {
            if (wordArrayLength(ta.slice(0,i+1), ctx) > ctx.canvas.width) {
                var cutpt = Math.max(i,1);
                return [ta.slice(0,cutpt)].concat(breakTextArray(ta.slice(cutpt),ctx));
            }

        }

    }
    console.log("wtf man");
    return [ta];
}

// find length of 1-D word array given canvas context
wordArrayLength = function(a, ctx) {
    var spc_width = ctx.measureText(" ").width;
    var total_length = 0;

    for (var i = 0; i < a.length; i++) {
        total_length += ctx.measureText(a[i]).width;
    }

    total_length += spc_width*(Math.max(a.length-1,0));

    console.log("wordArrayLength finds length of " + total_length);
    return total_length;
}

</script>

</head>

<body id="body">

    <div id="header">
        <div id="header_contents">
            <a href="/"><img src="static/waterlol_banner.png" /></a>
        </div>
    </div>

    <div id="c"> 
     <div class="lpanel" id="editor">
          <img id="staging_template" width="456" height="600" style="position: absolute;" />
          <canvas id="editor-canvas" width="456" height="600" style="position:relative; z-index: 100;"> </canvas>
          <form id="input" style="margin-top: 7px" enctype="multipart/form-data" method="post" onSubmit="return addMeme(this);" action="/addMeme">
              <input type="submit" name="bake" id="bake" value="bake" style="float:right;" tabindex=3 />
              <div class="textfield"><input class="memetext" type="text" style="margin-bottom: 1px" name="top" id="top" size="24" tabindex=1 /></div>
              <div class="textfield"><input class="memetext" type="text" style="margin-top: 1px" name="bottom" id="bottom" size="24" tabindex=2 /></div>
              <p>Don't see a template you like? <a href="addTemplate">Upload your own!</a><p />
          </form>
     </div> <!-- editor done --!>
     
     <div class="rpanel" id="thumbs">
     {% for t in templates %}
        <img src="/serve?t=t&id={{ t.0 }}&s=t" onclick="changeStaging(this);" w="{{ t.2 }}" h="{{t.3}}"/ id="{{ t.0 }}">
     {% endfor %}
     </div>

    </div>

</body>

</html>
